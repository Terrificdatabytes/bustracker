<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Tracking System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🚌</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --md-primary: #6750A4;
            --md-on-primary: #FFFFFF;
            --md-primary-container: #EADDFF;
            --md-on-primary-container: #21005D;
            --md-secondary: #625B71;
            --md-on-secondary: #FFFFFF;
            --md-secondary-container: #E8DEF8;
            --md-on-secondary-container: #1D192B;
            --md-tertiary: #7D5260;
            --md-on-tertiary: #FFFFFF;
            --md-error: #BA1A1A;
            --md-on-error: #FFFFFF;
            --md-surface: #FFFBFE;
            --md-on-surface: #1C1B1F;
            --md-surface-variant: #E7E0EC;
            --md-on-surface-variant: #49454F;
            --md-outline: #79747E;
            --md-shadow: rgba(0, 0, 0, 0.3);
            --md-elevation-1: 0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-elevation-2: 0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-elevation-3: 0 4px 8px 3px rgba(0, 0, 0, 0.15), 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            background-attachment: fixed;
            color: var(--md-on-surface);
            min-height: 100vh;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(103, 80, 164, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(125, 82, 96, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        h1 {
            text-align: center;
            color: var(--md-primary);
            margin-bottom: 8px;
            font-size: 2.5em;
            font-weight: 500;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: var(--md-on-surface-variant);
            margin-bottom: 24px;
            font-size: 1em;
        }

        .mode-buttons, .route-section {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--md-elevation-1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Roboto', sans-serif;
        }

        .btn:hover {
            box-shadow: var(--md-elevation-2);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .btn-success {
            background: #2E7D32;
            color: white;
        }

        .btn-danger {
            background: var(--md-error);
            color: var(--md-on-error);
        }

        .btn-info {
            background: #0277BD;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        select {
            padding: 12px 16px;
            font-size: 14px;
            border: 1px solid var(--md-outline);
            border-radius: 8px;
            min-width: 250px;
            background: var(--md-surface);
            color: var(--md-on-surface);
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: var(--md-primary);
            border-width: 2px;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            box-shadow: var(--md-elevation-1);
        }

        .info-panel {
            background: var(--md-surface-variant);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-outline);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: var(--md-on-surface-variant);
        }

        .info-value {
            color: var(--md-on-surface);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .value-updating {
            animation: numberChange 0.4s ease;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 16px 0;
            padding: 12px;
            background: var(--md-surface-variant);
            border-radius: 24px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #FFC107;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2E7D32;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .waiting-list-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: var(--md-surface);
            border-radius: 8px;
            box-shadow: var(--md-elevation-1);
            border-left: 4px solid var(--md-primary);
        }

        .waiting-count {
            background: var(--md-primary);
            color: var(--md-on-primary);
            padding: 4px 12px;
            border-radius: 16px;
            font-weight: 500;
            font-size: 12px;
        }

        .traffic-control {
            margin: 16px 0;
        }

        .traffic-control label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--md-surface-variant);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--md-primary);
            cursor: pointer;
            box-shadow: var(--md-elevation-1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--md-primary);
            cursor: pointer;
            border: none;
            box-shadow: var(--md-elevation-1);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--md-surface);
            padding: 32px;
            border-radius: 28px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--md-elevation-3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            color: var(--md-on-surface);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .modal-header p {
            color: var(--md-on-surface-variant);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--md-on-surface);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--md-outline);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            background: var(--md-surface);
            color: var(--md-on-surface);
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--md-primary);
            border-width: 2px;
        }

        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .form-toggle {
            text-align: center;
            margin-top: 16px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }

        .form-toggle a {
            color: var(--md-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .form-toggle a:hover {
            text-decoration: underline;
        }

        .driver-info {
            background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-tertiary) 100%);
            color: var(--md-on-primary);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: var(--md-elevation-2);
        }

        .driver-info h3 {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .driver-info p {
            margin: 4px 0;
            opacity: 0.95;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: var(--md-primary-container);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-label {
            font-size: 12px;
            color: var(--md-on-primary-container);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-on-primary-container);
            transition: all 0.3s ease;
        }

        /* TradingView-style animations */
        @keyframes flashGreen {
            0% { background-color: rgba(46, 125, 50, 0.3); transform: scale(1); }
            50% { background-color: rgba(46, 125, 50, 0.6); transform: scale(1.05); }
            100% { background-color: transparent; transform: scale(1); }
        }

        @keyframes flashRed {
            0% { background-color: rgba(244, 67, 54, 0.3); transform: scale(1); }
            50% { background-color: rgba(244, 67, 54, 0.6); transform: scale(1.05); }
            100% { background-color: transparent; transform: scale(1); }
        }

        @keyframes flashBlue {
            0% { background-color: rgba(33, 150, 243, 0.3); transform: scale(1); }
            50% { background-color: rgba(33, 150, 243, 0.6); transform: scale(1.05); }
            100% { background-color: transparent; transform: scale(1); }
        }

        @keyframes numberChange {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-5px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes ripple {
            0% { box-shadow: 0 0 0 0 rgba(103, 80, 164, 0.7); }
            100% { box-shadow: 0 0 0 20px rgba(103, 80, 164, 0); }
        }

        .flash-up {
            animation: flashGreen 0.6s ease;
        }

        .flash-down {
            animation: flashRed 0.6s ease;
        }

        .flash-update {
            animation: flashBlue 0.6s ease;
        }

        .number-change {
            animation: numberChange 0.4s ease;
        }

        .stat-card.updating {
            animation: ripple 0.6s ease;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
        }

        .recenter-btn {
            padding: 8px 16px;
            font-size: 12px;
            white-space: nowrap;
        }

        .recenter-btn .material-symbols-outlined {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            #map {
                height: 350px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .chip-desktop {
                display: none;
            }

            .recenter-btn {
                padding: 10px 12px;
                font-size: 13px;
                width: 100%;
                justify-content: center;
            }

            .recenter-text {
                display: none;
            }

            .recenter-btn .material-symbols-outlined {
                font-size: 24px;
                margin: 0;
            }

            #mapContainer > div:first-child {
                flex-direction: column;
                align-items: stretch;
            }

            #mapContainer h3 {
                text-align: center;
            }
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: var(--md-elevation-2);
        }

        .custom-popup {
            text-align: center;
            padding: 8px;
        }

        .custom-popup h4 {
            margin-bottom: 4px;
            color: var(--md-on-surface);
        }

        .info-box {
            margin-top: 16px;
            padding: 16px;
            background: var(--md-secondary-container);
            border-radius: 12px;
            font-size: 13px;
            color: var(--md-on-secondary-container);
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="modeSelection" class="card">
            <h1>🚌 Bus Tracking System</h1>
            <p class="subtitle">Real-time bus location tracking with ML-powered ETA predictions</p>
            
            <div id="connectionStatus" class="status-indicator">
                <div class="status-dot"></div>
                <span id="statusText">Connecting...</span>
            </div>

            <div class="mode-buttons">
                <button id="busMode" class="btn btn-primary">
                    <span class="material-symbols-outlined">directions_bus</span>
                    Bus Driver Mode
                </button>
                <button id="passengerMode" class="btn btn-primary">
                    <span class="material-symbols-outlined">person</span>
                    Passenger Mode
                </button>
            </div>
        </div>

        <div id="routeSelection" class="card hidden">
            <h2>Select Route</h2>
            <div class="route-section">
                <select id="routeSelect">
                    <option value="">-- Select Route --</option>
                </select>
            </div>
        </div>

        <div id="busUI" class="card hidden">
            <div class="driver-info">
                <h3>👤 Driver: <span id="driverName">Not Set</span></h3>
                <p>🚌 Bus ID: <span id="busId">Waiting...</span></p>
                <p>🛣️ Route: <span id="busRoute"></span></p>
            </div>

            <div class="info-panel">
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value" id="busStatus">Not Sharing</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Active Buses on Route:</span>
                    <span class="info-value" id="busCount">0</span>
                </div>
            </div>

            <div id="driverStats" class="hidden">
                <h3 style="margin: 16px 0 12px 0;">📊 Real-time Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card" id="speedCard">
                        <div class="stat-label">Speed</div>
                        <div class="stat-value"><span id="busSpeed">0</span> km/h</div>
                    </div>
                    <div class="stat-card" id="stopCard">
                        <div class="stat-label">Next Stop</div>
                        <div class="stat-value" style="font-size: 14px; overflow: hidden; text-overflow: ellipsis;">
                            <span id="nearestStopDriver">--</span>
                        </div>
                    </div>
                    <div class="stat-card" id="distanceCard">
                        <div class="stat-label">Distance</div>
                        <div class="stat-value"><span id="distanceToStop">--</span></div>
                    </div>
                    <div class="stat-card" id="etaCard">
                        <div class="stat-label">ETA</div>
                        <div class="stat-value"><span id="etaToStop">--</span> min</div>
                    </div>
                </div>
            </div>

            <div class="traffic-control">
                <label for="trafficLevel">
                    🚦 Traffic Level: <strong><span id="trafficValue">1.0</span></strong>
                </label>
                <input type="range" id="trafficLevel" min="1" max="3" step="0.1" value="1">
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--md-on-surface-variant);">
                    <span>Light</span>
                    <span>Moderate</span>
                    <span>Heavy</span>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
                <button id="startSharing" class="btn btn-success">
                    <span class="material-symbols-outlined">location_on</span>
                    Start Sharing Location
                </button>
                <button id="stopSharing" class="btn btn-danger hidden">
                    <span class="material-symbols-outlined">stop_circle</span>
                    Stop Sharing
                </button>
            </div>
        </div>

        <div id="passengerUI" class="card hidden">
            <h2>🚏 Passenger View - Route <span id="passengerRoute"></span></h2>

            <div class="info-panel">
                <div class="stats-grid" style="margin: 0;">
                    <div class="stat-card" id="passengerEtaCard">
                        <div class="stat-label">ETA</div>
                        <div class="stat-value"><span id="etaMinutes">--</span> min</div>
                    </div>
                    <div class="stat-card" id="passengerDistanceCard">
                        <div class="stat-label">Distance</div>
                        <div class="stat-value" style="font-size: 18px;"><span id="distance">--</span></div>
                    </div>
                    <div class="stat-card" id="passengerStopCard">
                        <div class="stat-label">Nearest Stop</div>
                        <div class="stat-value" style="font-size: 14px; overflow: hidden; text-overflow: ellipsis;">
                            <span id="nearestStop">--</span>
                        </div>
                    </div>
                    <div class="stat-card" id="passengerSpeedCard">
                        <div class="stat-label">Bus Speed</div>
                        <div class="stat-value" style="font-size: 18px;"><span id="busSpeedPassenger">--</span></div>
                    </div>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">Select Your Stop:</label>
                <select id="waitingStopSelect" style="margin-bottom: 12px;">
                    <option value="">-- Select your stop --</option>
                </select>
                <button id="waitingToggle" class="btn btn-info">
                    <span class="material-symbols-outlined">pan_tool</span>
                    I'm Waiting at This Stop
                </button>
            </div>

            <div>
                <h3 style="margin-bottom: 12px;">👥 Passengers Waiting</h3>
                <div id="waitingList" class="waiting-list"></div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                <button id="trackBus" class="btn btn-success">
                    <span class="material-symbols-outlined">search</span>
                    Track Bus
                </button>
                <button id="stopTracking" class="btn btn-danger hidden">
                    <span class="material-symbols-outlined">stop_circle</span>
                    Stop Tracking
                </button>
            </div>

            <div id="etaInfo" class="info-panel hidden" style="margin-top: 20px;">
                <p style="text-align: center; font-weight: 500;">Tracking active buses on your route...</p>
                <div class="eta-display" style="display: none; margin-top: 12px;"></div>
            </div>
        </div>

        <div id="mapContainer" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                <h3 style="margin: 0; flex: 1;">
                    🗺️ Live Map 
                    <span class="chip chip-desktop">Interactive - Drag to explore</span>
                </h3>
                <button id="recenterMap" class="btn btn-info recenter-btn" style="display: none;">
                    <span class="material-symbols-outlined">my_location</span>
                    <span class="recenter-text">Center on Bus</span>
                </button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <div id="driverAuthModal" class="modal">
        <div class="modal-content">
            <div id="loginForm">
                <div class="modal-header">
                    <h2>🔐 Driver Login</h2>
                    <p>Enter your credentials to continue</p>
                </div>

                <div class="form-group">
                    <label for="loginDriverId">Driver ID</label>
                    <input type="text" id="loginDriverId" placeholder="e.g., DRIVER001" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
                </div>

                <div class="form-actions">
                    <button id="loginBtn" class="btn btn-primary" style="width: 100%;">
                        <span class="material-symbols-outlined">login</span>
                        Login
                    </button>
                </div>

                <div class="form-toggle">
                    Don't have an account? <a href="#" id="showRegister">Register here</a>
                </div>

                <div class="info-box">
                    <strong>📌 Default Login Credentials:</strong>
                    Driver ID: <code>DRIVER001</code><br>
                    Password: <code>admin123</code>
                </div>
            </div>

            <div id="registerForm" class="hidden">
                <div class="modal-header">
                    <h2>📝 Driver Registration</h2>
                    <p>Create a new driver account</p>
                </div>

                <div class="form-group">
                    <label for="regDriverId">Driver ID</label>
                    <input type="text" id="regDriverId" placeholder="Choose a unique ID" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" placeholder="Choose a secure password" autocomplete="new-password">
                </div>

                <div class="form-group">
                    <label for="regName">Full Name</label>
                    <input type="text" id="regName" placeholder="Your full name" autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="regPhone">Phone Number</label>
                    <input type="tel" id="regPhone" placeholder="10-digit phone number" autocomplete="tel">
                </div>

                <div class="form-group">
                    <label for="regLicense">License Number</label>
                    <input type="text" id="regLicense" placeholder="Driving license number" autocomplete="off">
                </div>

                <div class="form-actions">
                    <button id="registerBtn" class="btn btn-success" style="width: 100%;">
                        <span class="material-symbols-outlined">person_add</span>
                        Register
                    </button>
                </div>

                <div class="form-toggle">
                    Already have an account? <a href="#" id="showLogin">Login here</a>
                </div>
            </div>
        </div>
    </div>

    <script>
// Global state
let socket;
let map;
let busMarkers = {};
let userMarker;
let stopMarkers = [];
let currentMode = null;
let currentRoute = null;
let trackingInterval = null;
let isSharing = false;
let isWaiting = false;
let currentWaitingStop = null;
let myBusId = null;
let updateInterval = null;
let driverInfo = null;
let isAuthenticated = false;
let isTracking = false;
let wakeLock = null;

// Store previous values for animation detection
let previousValues = {
    speed: null,
    distance: null,
    eta: null,
    passengerEta: null,
    passengerDistance: null,
    passengerSpeed: null
};

// Wake Lock API - Prevent screen from turning off
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('✓ Screen wake lock activated');
            
            wakeLock.addEventListener('release', () => {
                console.log('Screen wake lock released');
            });
            
            // Re-acquire wake lock when page becomes visible again
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('✓ Screen wake lock re-acquired');
                }
            });
            
            return true;
        } else {
            console.log('⚠ Wake Lock API not supported');
            return false;
        }
    } catch (err) {
        console.error(`Wake Lock error: ${err.name}, ${err.message}`);
        return false;
    }
}

async function releaseWakeLock() {
    if (wakeLock !== null) {
        try {
            await wakeLock.release();
            wakeLock = null;
            console.log('✓ Screen wake lock released');
        } catch (err) {
            console.error(`Wake Lock release error: ${err}`);
        }
    }
}

// DOM Elements
const modeSelection = document.getElementById('modeSelection');
const routeSelection = document.getElementById('routeSelection');
const busUI = document.getElementById('busUI');
const passengerUI = document.getElementById('passengerUI');
const mapContainer = document.getElementById('mapContainer');
const connectionStatus = document.getElementById('connectionStatus');
const statusText = document.getElementById('statusText');
const statusDot = connectionStatus.querySelector('.status-dot');

// Driver Authentication Elements
const driverAuthModal = document.getElementById('driverAuthModal');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const showRegisterBtn = document.getElementById('showRegister');
const showLoginBtn = document.getElementById('showLogin');

// Format distance display (km or meters)
function formatDistance(distanceKm) {
    if (distanceKm < 1) {
        const meters = Math.round(distanceKm * 1000);
        return `${meters} m`;
    } else {
        return `${distanceKm.toFixed(2)} km`;
    }
}

// TradingView-style animation helper
function animateValueChange(elementId, newValue, cardId = null) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const oldValue = element.textContent;
    
    // Skip if value hasn't changed
    if (oldValue === newValue.toString()) return;
    
    // Add number change animation
    element.classList.add('number-change');
    
    // Determine if value increased or decreased
    const oldNum = parseFloat(oldValue);
    const newNum = parseFloat(newValue);
    
    if (cardId && !isNaN(oldNum) && !isNaN(newNum)) {
        const card = document.getElementById(cardId);
        if (card) {
            // Remove any existing animation classes
            card.classList.remove('flash-up', 'flash-down', 'flash-update');
            
            // Add appropriate flash animation
            if (newNum > oldNum) {
                card.classList.add('flash-up');
            } else if (newNum < oldNum) {
                card.classList.add('flash-down');
            } else {
                card.classList.add('flash-update');
            }
            
            // Remove animation class after completion
            setTimeout(() => {
                card.classList.remove('flash-up', 'flash-down', 'flash-update');
            }, 600);
        }
    }
    
    // Update the value
    element.textContent = newValue;
    
    // Remove animation class after completion
    setTimeout(() => {
        element.classList.remove('number-change');
    }, 400);
}

// Animate info value changes
function animateInfoValue(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const oldValue = element.textContent;
    if (oldValue === newValue.toString()) return;
    
    element.classList.add('value-updating');
    element.textContent = newValue;
    
    setTimeout(() => {
        element.classList.remove('value-updating');
    }, 400);
}

// Initialize Socket.IO
function initSocket() {
    socket = io({
        transports: ['websocket', 'polling'],
        upgrade: true,
        rememberUpgrade: true,
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
    });
    
    socket.on('connect', () => {
        console.log('✓ Connected to server');
        statusText.textContent = 'Connected';
        statusDot.classList.add('connected');
        
        if (driverInfo && currentMode === 'bus') {
            socket.emit('driver_authenticate', {
                driver_id: driverInfo.driver_id,
                password: driverInfo.password
            });
        }
        
        if (currentRoute && currentMode && (currentMode === 'passenger' || isAuthenticated)) {
            socket.emit('join_route', { 
                route_id: currentRoute, 
                mode: currentMode,
                bus_id: myBusId 
            });
        }
    });
    
    socket.on('disconnect', () => {
        console.log('✗ Disconnected from server');
        statusText.textContent = 'Disconnected';
        statusDot.classList.remove('connected');
    });
    
    socket.on('connected', (data) => {
        console.log('Socket connected:', data);
    });
    
    socket.on('driver_authenticated', handleDriverAuthentication);
    socket.on('authentication_required', handleAuthenticationRequired);
    socket.on('bus_id_assigned', (data) => {
        myBusId = data.bus_id;
        console.log('✓ Assigned bus ID:', myBusId);
        document.getElementById('busId').textContent = myBusId;
        if (data.driver_name) {
            document.getElementById('driverName').textContent = data.driver_name;
        }
    });
    
    socket.on('bus_update', handleBusUpdate);
    socket.on('all_buses_update', handleAllBusesUpdate);
    socket.on('bus_removed', handleBusRemoved);
    socket.on('bus_count_update', handleBusCountUpdate);
    socket.on('waiting_update', handleWaitingUpdate);
    socket.on('waiting_stats', handleWaitingStats);
    socket.on('bus_info_update', handleBusInfoUpdate);
}

function handleDriverAuthentication(data) {
    if (data.success) {
        isAuthenticated = true;
        driverInfo.driver_id = data.driver.driver_id;
        driverInfo.name = data.driver.name;
        driverAuthModal.style.display = 'none';
        console.log('✓ Driver authenticated successfully');
        
        if (currentRoute) {
            socket.emit('join_route', { route_id: currentRoute, mode: 'bus' });
        }
    } else {
        alert(data.message || 'Authentication failed');
        isAuthenticated = false;
    }
}

function handleAuthenticationRequired(data) {
    alert(data.message);
    showDriverAuthModal();
}

function showDriverAuthModal() {
    driverAuthModal.style.display = 'flex';
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
}

function handleBusInfoUpdate(data) {
    // Update driver panel with real-time info and animations
    animateValueChange('busSpeed', data.speed, 'speedCard');
    animateValueChange('nearestStopDriver', data.nearest_stop, 'stopCard');
    animateValueChange('distanceToStop', formatDistance(data.distance_to_stop), 'distanceCard');
    animateValueChange('etaToStop', data.eta_to_stop, 'etaCard');
}

document.getElementById('loginBtn').addEventListener('click', async () => {
    const driverId = document.getElementById('loginDriverId').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!driverId || !password) {
        alert('Please enter Driver ID and Password');
        return;
    }
    
    driverInfo = { driver_id: driverId, password: password };
    
    socket.emit('driver_authenticate', {
        driver_id: driverId,
        password: password
    });
});

document.getElementById('loginPassword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('loginBtn').click();
    }
});

document.getElementById('registerBtn').addEventListener('click', async () => {
    const driverId = document.getElementById('regDriverId').value.trim();
    const password = document.getElementById('regPassword').value;
    const name = document.getElementById('regName').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const license = document.getElementById('regLicense').value.trim();
    
    if (!driverId || !password || !name || !phone || !license) {
        alert('Please fill all fields');
        return;
    }
    
    try {
        const response = await fetch('/api/driver/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                driver_id: driverId,
                password: password,
                name: name,
                phone: phone,
                license_number: license
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Registration successful! Please login.');
            showLoginBtn.click();
            document.getElementById('loginDriverId').value = driverId;
        } else {
            alert(data.message || 'Registration failed');
        }
    } catch (error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
    }
});

showRegisterBtn.addEventListener('click', (e) => {
    e.preventDefault();
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
});

showLoginBtn.addEventListener('click', (e) => {
    e.preventDefault();
    registerForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
});

async function loadRoutes() {
    try {
        const response = await fetch('/api/routes');
        const data = await response.json();
        
        const routeSelect = document.getElementById('routeSelect');
        data.routes.forEach(route => {
            const option = document.createElement('option');
            option.value = route;
            option.textContent = `Route ${route}`;
            routeSelect.appendChild(option);
        });
        
        window.stopsData = data.stops;
    } catch (error) {
        console.error('Error loading routes:', error);
    }
}

function initMap(centerLat = 9.9252, centerLng = 78.1198) {
    if (map) {
        map.remove();
    }
    
    map = L.map('map', {
        dragging: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: true,
        zoomControl: true
    }).setView([centerLat, centerLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19,
        updateWhenIdle: false,
        updateWhenZooming: false,
        keepBuffer: 2
    }).addTo(map);
    
    return map;
}

function addStopMarkers(route) {
    stopMarkers.forEach(marker => map.removeLayer(marker));
    stopMarkers = [];
    
    if (!window.stopsData || !window.stopsData[route]) return;
    
    const stops = window.stopsData[route];
    
    stops.forEach(stop => {
        const marker = L.marker([stop.lat, stop.lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: #2196F3; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); white-space: nowrap;">
                    ${stop.id}
                </div>`,
                iconSize: [40, 40]
            })
        }).addTo(map);
        
        marker.bindPopup(`
            <div class="custom-popup">
                <h4>${stop.name}</h4>
                <p>Stop ID: ${stop.id}</p>
            </div>
        `);
        
        stopMarkers.push(marker);
    });
}

document.getElementById('busMode').addEventListener('click', () => {
    currentMode = 'bus';
    modeSelection.classList.add('hidden');
    routeSelection.classList.remove('hidden');
});

document.getElementById('passengerMode').addEventListener('click', () => {
    currentMode = 'passenger';
    modeSelection.classList.add('hidden');
    routeSelection.classList.remove('hidden');
});

document.getElementById('routeSelect').addEventListener('change', (e) => {
    currentRoute = e.target.value;
    
    if (!currentRoute) return;
    
    if (currentMode === 'bus') {
        setupBusMode();
    } else {
        setupPassengerMode();
    }
});

function setupBusMode() {
    showDriverAuthModal();
    
    routeSelection.classList.add('hidden');
    busUI.classList.remove('hidden');
    mapContainer.classList.remove('hidden');
    
    document.getElementById('busRoute').textContent = currentRoute;
    
    const stops = window.stopsData[currentRoute];
    if (stops && stops.length > 0) {
        initMap(stops[0].lat, stops[0].lng);
        addStopMarkers(currentRoute);
    } else {
        initMap();
    }
}

function setupPassengerMode() {
    routeSelection.classList.add('hidden');
    passengerUI.classList.remove('hidden');
    mapContainer.classList.remove('hidden');
    
    document.getElementById('passengerRoute').textContent = currentRoute;
    
    const waitingStopSelect = document.getElementById('waitingStopSelect');
    waitingStopSelect.innerHTML = '<option value="">-- Select your stop --</option>';
    
    const stops = window.stopsData[currentRoute];
    if (stops) {
        stops.forEach(stop => {
            const option = document.createElement('option');
            option.value = stop.id;
            option.textContent = `${stop.name} (Stop ${stop.id})`;
            waitingStopSelect.appendChild(option);
        });
    }
    
    if (stops && stops.length > 0) {
        initMap(stops[0].lat, stops[0].lng);
        addStopMarkers(currentRoute);
    } else {
        initMap();
    }
    
    socket.emit('join_route', { route_id: currentRoute, mode: 'passenger' });
    
    loadWaitingStats();
}

document.getElementById('trafficLevel').addEventListener('input', (e) => {
    document.getElementById('trafficValue').textContent = parseFloat(e.target.value).toFixed(1);
});

document.getElementById('startSharing').addEventListener('click', async () => {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }
    
    if (!myBusId) {
        alert('Bus ID not assigned yet. Please wait...');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate first');
        showDriverAuthModal();
        return;
    }
    
    isSharing = true;
    document.getElementById('startSharing').classList.add('hidden');
    document.getElementById('stopSharing').classList.remove('hidden');
    document.getElementById('busStatus').textContent = 'Sharing Location (Live)';
    document.getElementById('busStatus').style.color = '#4CAF50';
    document.getElementById('recenterMap').style.display = 'inline-flex';
    
    document.getElementById('driverStats').classList.remove('hidden');
    
    // Request wake lock to keep screen on
    const wakeLockEnabled = await requestWakeLock();
    if (wakeLockEnabled) {
        console.log('✓ Screen will stay on while sharing location');
    }
    
    // Start continuous location tracking with watchPosition
    trackingInterval = navigator.geolocation.watchPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            const trafficLevel = parseFloat(document.getElementById('trafficLevel').value);
            
            console.log(`📍 Location update: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
            
            socket.emit('bus_location', {
                route_id: currentRoute,
                bus_id: myBusId,
                lat: latitude,
                lng: longitude,
                traffic_level: trafficLevel
            });
            
            updateBusMarker(myBusId, latitude, longitude, true);
        },
        (error) => {
            console.error('Geolocation error:', error);
            if (error.code === error.PERMISSION_DENIED) {
                alert('Location permission denied. Please enable location services.');
                document.getElementById('stopSharing').click();
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0  // Don't use cached positions - always get fresh location
        }
    );
});

document.getElementById('stopSharing').addEventListener('click', () => {
    isSharing = false;
    
    // Stop watchPosition tracking
    if (trackingInterval) {
        navigator.geolocation.clearWatch(trackingInterval);
        trackingInterval = null;
    }
    
    socket.emit('leave_route', { 
        route_id: currentRoute, 
        mode: 'bus',
        bus_id: myBusId 
    });
    
    document.getElementById('stopSharing').classList.add('hidden');
    document.getElementById('startSharing').classList.remove('hidden');
    document.getElementById('busStatus').textContent = 'Stopped';
    document.getElementById('busStatus').style.color = '#666';
    document.getElementById('driverStats').classList.add('hidden');
    document.getElementById('recenterMap').style.display = 'none';
    
    // Release wake lock
    releaseWakeLock();
    
    if (busMarkers[myBusId]) {
        map.removeLayer(busMarkers[myBusId]);
        delete busMarkers[myBusId];
    }
});

function shareLocation() {
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            
            const trafficLevel = parseFloat(document.getElementById('trafficLevel').value);
            
            socket.emit('bus_location', {
                route_id: currentRoute,
                bus_id: myBusId,
                lat: latitude,
                lng: longitude,
                traffic_level: trafficLevel
            });
            
            updateBusMarker(myBusId, latitude, longitude, true);
        },
        (error) => {
            console.error('Geolocation error:', error);
            if (error.code === error.PERMISSION_DENIED) {
                alert('Location permission denied. Please enable location services.');
                document.getElementById('stopSharing').click();
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

function updateBusMarker(busId, lat, lng, isOwnBus = false, driverName = null) {
    if (!map) {
        console.error('Map not initialized!');
        return;
    }
    
    const color = isOwnBus ? '#4CAF50' : '#FF9800';
    const label = isOwnBus ? '🚌' : '🚍';
    
    if (busMarkers[busId]) {
        busMarkers[busId].setLatLng([lat, lng]);
    } else {
        busMarkers[busId] = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'bus-marker',
                html: `<div style="background: ${color}; color: white; padding: 8px; border-radius: 50%; font-size: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${label}</div>`,
                iconSize: [40, 40]
            })
        }).addTo(map);
        
        const popupText = driverName ? `Driver: ${driverName}` : (isOwnBus ? 'Your Bus' : 'Active Bus');
        
        busMarkers[busId].bindPopup(`
            <div class="custom-popup">
                <h4>${label} Bus ${busId.substring(0, 8)}</h4>
                <p>${popupText}</p>
            </div>
        `);
        
        // Only center on first bus marker or if it's the only marker
        if (Object.keys(busMarkers).length === 1) {
            map.setView([lat, lng], 14);
        }
    }
}

function removeBusMarker(busId) {
    if (busMarkers[busId]) {
        map.removeLayer(busMarkers[busId]);
        delete busMarkers[busId];
    }
}

function showMessage(status, route) {
    const etaInfoDiv = document.getElementById('etaInfo');
    const trackingMsg = etaInfoDiv ? etaInfoDiv.querySelector('p') : null;
    const etaDisplay = etaInfoDiv ? etaInfoDiv.querySelector('.eta-display') : null;
    
    const messages = {
        loading: `🔍 Searching for buses on Route ${route}...`,
        found: `✅ Bus found on Route ${route}! Tracking now...`,
        nobus: `❌ No buses found on Route ${route}....`,
        error: `⚠️ Error loading buses on Route ${route}. Please try again.`,
        multiple: `✅ Multiple buses found on Route ${route}! Displaying closest bus...`
    };
    
    if (trackingMsg) {
        trackingMsg.textContent = messages[status] || messages.loading;
        trackingMsg.style.display = 'block';
    }
    
    if (status === 'found' || status === 'multiple') {
        if (etaDisplay) {
            etaDisplay.style.display = 'grid';
        }
    } else if (status === 'nobus' || status === 'loading' || status === 'error') {
        if (etaDisplay) {
            etaDisplay.style.display = 'none';
        }
    }
}

const trackBusBtn = document.getElementById('trackBus');
if (trackBusBtn) {
    trackBusBtn.addEventListener('click', async () => {
        console.log('=== TRACK BUS CLICKED ===');
        
        if (!map) {
            alert('Map not initialized. Please refresh the page.');
            return;
        }
        
        if (!currentRoute) {
            alert('No route selected!');
            return;
        }
        
        isTracking = true;
        trackBusBtn.classList.add('hidden');
        document.getElementById('stopTracking').classList.remove('hidden');
        document.getElementById('etaInfo').classList.remove('hidden');
        document.getElementById('recenterMap').style.display = 'inline-flex';
        
        // Request wake lock to keep screen on
        const wakeLockEnabled = await requestWakeLock();
        if (wakeLockEnabled) {
            console.log('✓ Screen will stay on while tracking bus');
        }
        
        showMessage('loading', currentRoute);
        
        loadActiveBuses();
        updateInterval = setInterval(loadActiveBuses, 2000);
    });
}

document.getElementById('stopTracking').addEventListener('click', () => {
    isTracking = false;
    document.getElementById('stopTracking').classList.add('hidden');
    document.getElementById('trackBus').classList.remove('hidden');
    document.getElementById('etaInfo').classList.add('hidden');
    document.getElementById('recenterMap').style.display = 'none';
    
    // Release wake lock
    releaseWakeLock();
    
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
    
    Object.keys(busMarkers).forEach(busId => {
        if (busMarkers[busId]) {
            map.removeLayer(busMarkers[busId]);
        }
    });
    busMarkers = {};
});

// Recenter map button handler
document.getElementById('recenterMap').addEventListener('click', () => {
    const busIds = Object.keys(busMarkers);
    
    if (busIds.length === 0) {
        alert('No buses to center on');
        return;
    }
    
    if (busIds.length === 1) {
        // Single bus - center on it
        const marker = busMarkers[busIds[0]];
        const latlng = marker.getLatLng();
        map.setView([latlng.lat, latlng.lng], 15);
    } else {
        // Multiple buses - fit all in view
        const bounds = L.latLngBounds();
        busIds.forEach(busId => {
            const marker = busMarkers[busId];
            if (marker) {
                bounds.extend(marker.getLatLng());
            }
        });
        map.fitBounds(bounds, { padding: [50, 50] });
    }
});

async function loadActiveBuses() {
    try {
        const url = `/api/active_buses/${currentRoute}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.buses && data.buses.length > 0) {
            if (data.buses.length === 1) {
                showMessage('found', currentRoute);
            } else {
                showMessage('multiple', currentRoute);
            }
            
            const activeBusIds = [];
            
            data.buses.forEach(bus => {
                activeBusIds.push(bus.bus_id);
                updateBusMarker(bus.bus_id, bus.lat, bus.lng, false, bus.driver_name);
            });
            
            Object.keys(busMarkers).forEach(busId => {
                if (!activeBusIds.includes(busId)) {
                    removeBusMarker(busId);
                }
            });
            
            updateClosestBusETA();
        } else {
            showMessage('nobus', currentRoute);
            
            Object.keys(busMarkers).forEach(busId => {
                removeBusMarker(busId);
            });
            
            animateValueChange('etaMinutes', '--', 'passengerEtaCard');
            animateValueChange('distance', '--', 'passengerDistanceCard');
            animateValueChange('nearestStop', 'No buses active', 'passengerStopCard');
            animateValueChange('busSpeedPassenger', '--', 'passengerSpeedCard');
        }
    } catch (error) {
        console.error('Error loading active buses:', error);
        showMessage('error', currentRoute);
    }
}

document.getElementById('waitingToggle').addEventListener('click', function() {
    const stopSelect = document.getElementById('waitingStopSelect');
    const stopId = parseInt(stopSelect.value);
    
    if (!stopId) {
        alert('Please select a stop first');
        return;
    }
    
    isWaiting = !isWaiting;
    
    socket.emit('passenger_waiting', {
        route_id: currentRoute,
        stop_id: stopId,
        is_waiting: isWaiting
    });
    
    if (isWaiting) {
        this.textContent = 'Cancel Waiting';
        this.classList.remove('btn-info');
        this.classList.add('btn-danger');
        currentWaitingStop = stopId;
    } else {
        this.textContent = "I'm Waiting at This Stop";
        this.classList.remove('btn-danger');
        this.classList.add('btn-info');
        currentWaitingStop = null;
    }
});

function handleBusUpdate(data) {
    updateBusMarker(data.bus_id, data.lat, data.lng, false);
    
    if (isTracking) {
        updateClosestBusETA();
    }
}

function handleAllBusesUpdate(data) {
    if (data.buses && data.buses.length > 0) {
        data.buses.forEach(bus => {
            updateBusMarker(bus.bus_id, bus.lat, bus.lng, false);
        });
        
        if (isTracking) {
            updateClosestBusETA();
        }
    }
}

function handleBusRemoved(data) {
    removeBusMarker(data.bus_id);
    if (isTracking) {
        updateClosestBusETA();
    }
}

function updateClosestBusETA() {
    const allBusIds = Object.keys(busMarkers);
    
    if (allBusIds.length === 0) {
        animateValueChange('etaMinutes', '--', 'passengerEtaCard');
        animateValueChange('distance', '--', 'passengerDistanceCard');
        animateValueChange('nearestStop', 'No buses active', 'passengerStopCard');
        animateValueChange('busSpeedPassenger', '--', 'passengerSpeedCard');
        return;
    }
    
    const waitingStopSelect = document.getElementById('waitingStopSelect');
    const selectedStopId = parseInt(waitingStopSelect.value);
    const stops = window.stopsData[currentRoute];
    
    let referenceStop = stops && stops.length > 0 ? stops[0] : null;
    
    if (selectedStopId && stops) {
        const userStop = stops.find(s => s.id === selectedStopId);
        if (userStop) {
            referenceStop = userStop;
        }
    }
    
    if (!referenceStop) {
        animateValueChange('etaMinutes', '--', 'passengerEtaCard');
        animateValueChange('distance', '--', 'passengerDistanceCard');
        animateValueChange('nearestStop', 'Stop data unavailable', 'passengerStopCard');
        animateValueChange('busSpeedPassenger', '--', 'passengerSpeedCard');
        return;
    }
    
    let closestBus = null;
    let minDistance = Infinity;
    
    allBusIds.forEach(busId => {
        const marker = busMarkers[busId];
        if (!marker) return;
        
        const latlng = marker.getLatLng();
        const dist = calculateDistance(referenceStop.lat, referenceStop.lng, latlng.lat, latlng.lng);
        
        if (dist < minDistance) {
            minDistance = dist;
            closestBus = busId;
        }
    });
    
    if (closestBus && minDistance !== Infinity) {
        const trafficLevel = 1.5;
        const etaMinutes = predictETA(minDistance, trafficLevel);
        
        fetch(`/api/active_buses/${currentRoute}`)
            .then(res => res.json())
            .then(data => {
                const busData = data.buses.find(b => b.bus_id === closestBus);
                if (busData) {
                    animateValueChange('busSpeedPassenger', `${busData.speed} km/h`, 'passengerSpeedCard');
                }
            });
        
        animateValueChange('etaMinutes', Math.round(etaMinutes), 'passengerEtaCard');
        animateValueChange('distance', formatDistance(minDistance), 'passengerDistanceCard');
        animateValueChange('nearestStop', referenceStop.name, 'passengerStopCard');
    } else {
        animateValueChange('etaMinutes', '--', 'passengerEtaCard');
        animateValueChange('distance', '--', 'passengerDistanceCard');
        animateValueChange('nearestStop', 'Calculating...', 'passengerStopCard');
        animateValueChange('busSpeedPassenger', '--', 'passengerSpeedCard');
    }
}

function predictETA(distanceKm, trafficLevel) {
    const baseSpeed = 30;
    const speed = baseSpeed / trafficLevel;
    return (distanceKm / speed) * 60;
}

function handleBusCountUpdate(data) {
    animateInfoValue('busCount', data.count);
}

function handleWaitingUpdate(data) {
    loadWaitingStats();
}

function handleWaitingStats(data) {
    updateWaitingDisplay(data);
}

async function loadWaitingStats() {
    try {
        const response = await fetch('/api/waiting_stats');
        const data = await response.json();
        updateWaitingDisplay(data);
    } catch (error) {
        console.error('Error loading waiting stats:', error);
    }
}

function updateWaitingDisplay(stats) {
    const waitingList = document.getElementById('waitingList');
    
    if (!stats || !stats[currentRoute]) {
        waitingList.innerHTML = '<p style="text-align: center; color: #999;">No one waiting currently</p>';
        return;
    }
    
    const routeStats = stats[currentRoute];
    const stops = window.stopsData[currentRoute];
    
    let html = '';
    Object.entries(routeStats).forEach(([stopId, count]) => {
        if (count > 0) {
            const stop = stops.find(s => s.id === parseInt(stopId));
            const stopName = stop ? stop.name : `Stop ${stopId}`;
            
            html += `
                <div class="waiting-list-item">
                    <span>${stopName}</span>
                    <span class="waiting-count">${count} waiting</span>
                </div>
            `;
        }
    });
    
    if (html === '') {
        html = '<p style="text-align: center; color: #999;">No one waiting currently</p>';
    }
    
    waitingList.innerHTML = html;
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function toRad(degrees) {
    return degrees * (Math.PI / 180);
}

window.addEventListener('beforeunload', () => {
    if (isSharing && myBusId) {
        // Clear watch position
        if (trackingInterval) {
            navigator.geolocation.clearWatch(trackingInterval);
        }
        
        socket.emit('leave_route', { 
            route_id: currentRoute, 
            mode: 'bus',
            bus_id: myBusId 
        });
    }
    
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    // Release wake lock on page unload
    releaseWakeLock();
});

console.log('=== Initializing Enhanced Bus Tracking System ===');
console.log('✓ TradingView-style animations enabled');
console.log('✓ Continuous GPS tracking with watchPosition');
console.log('✓ High-accuracy location updates (no throttling)');
console.log('Script loaded at:', new Date().toLocaleTimeString());

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded');
        initSocket();
        loadRoutes();
    });
} else {
    console.log('DOM already loaded');
    initSocket();
    loadRoutes();
}

window.addEventListener('load', () => {
    console.log('=== Page Fully Loaded ===');
    console.log('✓ All elements loaded');
    console.log('✓ Animation system ready');
    console.log('✓ Track Bus button exists:', !!document.getElementById('trackBus'));
    console.log('✓ Passenger UI exists:', !!document.getElementById('passengerUI'));
    console.log('✓ Map container exists:', !!document.getElementById('map'));
});
    </script>
</body>
</html>
